<!DOCTYPE html>
<html lang="en">
<head>
    <title>Automated, Bandwidth-Efficient, and Encrypted Backups</title>
    <meta charset="utf-8" />
    <meta name="robots" 
          content="noindex, nofollow">
    <link rel="stylesheet" 
          href="./theme/css/main.css" 
          type="text/css" />
        <link href="https://blog.patternsinthevoid.net/feeds/all.atom.xml" 
          type="application/atom+xml" 
          rel="alternate" 
          title="Patterns in the Void Atom Feed" />
                <link href="./theme/prettify/prettify.css"
          type="text/css"
          rel="stylesheet" />
    <script type="text/javascript" src="./theme/prettify/prettify.js"></script>
    
    <!--[if IE]>
        <script src="./theme/js/html5.js">
        </script>
        <![endif]-->

    <!--[if lte IE 7]>
        <link rel="stylesheet" type="text/css" media="all"
              href="./theme/css/ie.css"/>
        <script src="./theme/js/IE8.js"
                type="text/javascript"></script>
        <![endif]-->

    <!--[if lt IE 7]>
        <link rel="stylesheet" type="text/css" media="all"
              href="./theme/css/ie6.css"/>
        <![endif]-->
</head>

<body id="index" class="home" onload="prettyPrint()">
<a href="https://github.com/isislovecruft">
        <img style="position: absolute; top: 0; right: 0; border: 0; max-width: 48px;"
         src="https://blog.patternsinthevoid.net/theme/images/icons/github-tentacle-icon.png"
         alt="code." />
</a>
<header id="banner" class="body">
    <h1>
        <a href="./">Patterns in the Void 
                    </a>
    </h1>
    <nav>
        <ul>
                                                                                    <li >
                <a href="./category/anarchism.html">anarchism</a>
            </li>
                                                                        <li class="active">
                <a href="./category/hacking.html">hacking</a>
            </li>
                                                <li >
                <a href="./category/physics.html">physics</a>
            </li>
                                                <li >
                <a href="./category/travel.html">travel</a>
            </li>
                                </ul>
    </nav>
</header>

<!-- /#banner -->
<section id="content" class="body">
    <article>
        <header>
            <h1 class="entry-title">
                <a href="./automated-bandwidth-efficient-and-encrypted-backups.html" rel="bookmark"
                   title="Permalink to Automated, Bandwidth-Efficient, and Encrypted Backups">Automated, Bandwidth-Efficient, and Encrypted&nbsp;Backups</a>
            </h1>
            <a href="http://twitter.com/share"
   class="twitter-share-button"
   data-count="horizontal" 
   data-via="isislovecruft">Tweet</a>
<script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
        </header>
        <div class="entry-content">
            <footer class="post-info">
        <abbr class="published" title="2011-12-19T19:29:00">
                Monday, 19 December 2011
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="./author/isis-agora-lovecruft.html">isis agora lovecruft</a>
        </address>
        <p>In <a href="./category/hacking.html">hacking</a> </p>
<p>tags: <a href="./tag/backup.html">backup </a><a href="./tag/bash-scripting.html">bash scripting </a><a href="./tag/command-line.html">command line </a><a href="./tag/cryptography.html">cryptography </a><a href="./tag/duplicity.html">duplicity </a><a href="./tag/linux.html">linux </a></p>
</footer><!-- /.post-info -->            <p>I made a bash shell script to automate encrypted (remote or local) data
backups with <a href="http://duplicity.nongnu.org/" title="Duplicity">Duplicity</a>. Duplicity uses asymmetric <span class="caps">GPG</span> <span class="caps">RSA</span> keys to
encrypt a tarballs of specified files to be backed up, and it also
supports incremental backups. So, after making a full backup, it is more
efficient do to the fact that it only saves changes made to files and
not entirely new copies of files. Duplicity also supports versioning,
i.e. you can say &#8220;give me File A from 3 days&nbsp;ago&#8221;.</p>
<p>Duplicity is <em>not</em> efficient in it&#8217;s cryptographic design, as my friend
Tom wisely pointed out, in that use of asymmetric cryptographic
algorithms is heavily intensive upon processor resources, and it would
be better to replace this feature with something more along the lines of
the algorithms (e.g. <span class="caps">AES</span>, Serpent, and Twofish) and read/write speed
testing features which <a href="http://www.truecrypt.org/" title="TrueCrypt">TrueCrypt</a> supports, for&nbsp;example.</p>
<p>This script depends on both curl and a newer version of duplicity (which
is not yet included in the standard repositories), so to install those
dependencies in Ubuntu&nbsp;do:</p>
<p><code>$ sudo apt-add-repository ppa:duplicity-team/ppa</code></p>
<p>\$ sudo apt-get&nbsp;update</p>
<p>\$ sudo apt-get install duplicity&nbsp;curl</p>
<p>Here&#8217;s version 0.1.2 of the backup script [(or view it on github&nbsp;here)][]:</p>
<p>#!/bin/bash</p>
<p>#&nbsp;_____________________</p>
<p>#| <span class="caps">BACKUP</span>[your].<span class="caps">SH</span>[it]&nbsp;|</p>
<p>#|&#8211;&#8211;&#8211;&#8211;&#8211;&#8211;&#8211;|</p>
<p>#|v.0.1.2 |\ \^&nbsp;/\^</p>
<p>#|Written by | \ / \ //&nbsp;\  </p>
<p>#|isis agora lovecruft Lovecruft | \ |\___/| / \//&nbsp;.\  </p>
<p>#|isis agora lovecruft@patternsinthe | \ /O O \__ / // | \ \&nbsp;*&#8211;-*</p>
<p>#| void.net| / / \/_/ // | \ \ \&nbsp;|</p>
<p>#|_____________________| @___@` \/_ // | \  
\ \/\&nbsp;\  </p>
<p># 0/0/| \/_ // | \ \ \&nbsp;\  </p>
<p># 0/0/0/0/| \/// | \ \ |&nbsp;|</p>
<p># 0/0/0/0/0/_|_ / ( // | \ _\ |&nbsp;/</p>
<p># 0/0/0/0/0/0/`/,_ _ _/ ) ; -. | _ _&#46;-\~ /&nbsp;/</p>
<p># ,-} _ *-.|.-\~-. .\~&nbsp;\~</p>
<p># \ \__/ `/\ / \~-. _ .-\~&nbsp;/</p>
<p># \____(oo) *. } {&nbsp;/</p>
<p># ( (&#8212;) .&#8211;-\~-.\ &#45;`&nbsp;.\~</p>
<p># //__&#92; \__ zomg! ///.&#8211;-..\&lt; \ _&nbsp;-\~</p>
<p># // &#92; ///-._ _ _ _ _ _ _{\^ - - - -&nbsp;\~</p>
<p>#</p>
<p># Backup script to automate <span class="caps">SSH</span>, <span class="caps">SCP</span>, <span class="caps">SFTP</span>, <span class="caps">FTP</span>, and <span class="caps">IMAP</span> backups&nbsp;through</p>
<p># Duplicity. Duplicity encrypts backup files through <span class="caps">GPG</span> before&nbsp;sending</p>
<p># files through protocol. This script runs a check on the&nbsp;available</p>
<p># bandwidth, and only runs the backup when the bandwidth available&nbsp;is</p>
<p># above a configurable&nbsp;threshhold.</p>
<p>#</p>
<p># This is going to be rewritten using duplicati instead of duplicity in&nbsp;the</p>
<p># next major version&nbsp;release.</p>
<p><span class="caps">SPEED</span>=\$(curl -w %{speed_download} -o /dev/null -s&nbsp;http://speedtest.sea01.softlayer.com/speedtest/speedtest/random1000x1000.jpg)</p>
<p><span class="caps">INT</span>=\${<span class="caps">SPEED</span>/&#46;*}</p>
<p><span class="caps">KBPS</span>=\$(echo \$[<span class="caps">INT</span> /&nbsp;1024])</p>
<p><span class="caps">THRESHOLD</span>=&#8221;200&#8221;</p>
<p># Uncomment and set the following in order to not type your&nbsp;password.</p>
<p># This is incredibly insecure, as your password is then&nbsp;stored</p>
<p>#&nbsp;plaintext.</p>
<p>#export&nbsp;<span class="caps">PASSPHRASE</span>=&#8217;passphrase&#8217;</p>
<p># The \$<span class="caps">SPEED</span> variable downloads a nice image of snow (into /dev/null
so&nbsp;that</p>
<p># it isn&#8217;t actually saved anywhere on disk). It also gives us a&nbsp;write-out</p>
<p># (-w %{speed_download}) for the average available bandwidth
(incoming)&nbsp;in</p>
<p># bytes per&nbsp;second.</p>
<p>#</p>
<p># \$<span class="caps">INT</span> turns the float \$<span class="caps">SPEED</span> into an&nbsp;integer.</p>
<p>#</p>
<p># \$<span class="caps">KBPS</span>, as I&#8217;m sure you can surmise, turns the bytes per second&nbsp;into</p>
<p># kilobytes per&nbsp;second.</p>
<p>#</p>
<p># \$<span class="caps">THRESHOLD</span> can be changed to fit the user&#8217;s preferences, and it&nbsp;defines</p>
<p># the minimum bandwidth which should be available for a duplicity
backup&nbsp;to</p>
<p># take&nbsp;place.</p>
<p>if [[ &#8220;\$#&#8221; == &#8220;0&#8221; ]];&nbsp;then</p>
<p>echo&nbsp;&#8221;&#8220;</p>
<p>echo &#8220;Usage: ./backup.sh &#8230;&nbsp;&#8221;</p>
<p>echo&nbsp;&#8221;&#8220;</p>
<p>echo &#8220;Backup locations can be locally stored on the same disk (not
recommended),&nbsp;&#8221;</p>
<p>echo &#8220;or may be stored remotely. For remote backups, duplicity provides
several&nbsp;&#8221;</p>
<p>echo &#8220;options for transport, including <span class="caps">SCP</span>, <span class="caps">FTP</span>, and <span class="caps">IMAP</span>, please see
&#8216;man duplicity&#8217;&nbsp;&#8221;</p>
<p>echo &#8220;for more information. Also, all duplicity backups are
automatically GnuPG&nbsp;&#8221;</p>
<p>echo &#8220;encrypted, so transportation is much safer than it would be
otherwise.&nbsp;&#8221;</p>
<p>echo&nbsp;&#8221;&#8220;</p>
<p>echo &#8220;Note: Duplicity&#8217;s <span class="caps">SSH</span> backend performs a check that the remote
directory end&nbsp;&#8221;</p>
<p>echo &#8220;in a &#8216;/&#8217;, so this must be present for <span class="caps">SSH</span>, <span class="caps">SCP</span>, or <span class="caps">SFTP</span> backups to
work&nbsp;correctly.&#8221;</p>
<p>echo&nbsp;&#8221;&#8220;</p>
<p>exit&nbsp;1</p>
<p>fi</p>
<p># Make sure this script is run as&nbsp;root.</p>
<p>if [[ `id -u` != 0 ]];&nbsp;then</p>
<p>echo&nbsp;&#8221;&#8220;</p>
<p>echo &#8220;Sorry, backups must be made as root in order for files in the /
directory&nbsp;to&#8221;</p>
<p>echo &#8220;be backed up safely. Please do &#8216;sudo su&#8217; and try running this
script&nbsp;again.&#8221;</p>
<p>echo&nbsp;&#8220;Exiting&#8230;&#8221;</p>
<p>echo&nbsp;&#8221;&#8220;</p>
<p>exit&nbsp;1</p>
<p>fi</p>
<p># Set up BACKUP_TO_LOCATION positional&nbsp;parameters.</p>
<p>for i in &#8220;\$@&#8221;;&nbsp;do</p>
<p>\$(BACK_UP_LOCATION_\$i)=\$i</p>
<p>echo&nbsp;&#8221;&#8220;</p>
<p>echo &#8220;Would you like to make a full backup, or add an incremental backup
to the&nbsp;&#8221;</p>
<p>echo &#8220;last full backup&nbsp;stored?&#8221;</p>
<p>select fullinc in &#8220;Full&#8221; &#8220;Incremental&#8221;;&nbsp;do</p>
<p>case \$fullinc&nbsp;in</p>
<p>Full)</p>
<p><span class="caps">USERLIST</span>=\$(cat /etc/passwd | grep &#8220;/home&#8221; | grep -E
&#8220;([1-5][0-9]{3})|([5-9][0-9]{2})?&#8221; | cut -d : -f&nbsp;1)</p>
<p># fix above regex to match &#8216;1000&#8217;, &#8216;500&#8217; and&nbsp;&#8216;1392&#8217;</p>
<p>#</p>
<p># This command searches the password file for users with a home&nbsp;directory</p>
<p># (to filter out programs with user accounts) whose <span class="caps">UID</span> number is in&nbsp;the</p>
<p># range of 500-1599 (normal users, does not include root). It then&nbsp;takes</p>
<p># that returned list of users and cuts it (the delimiter is &#8220;:&#8221;) and&nbsp;returns</p>
<p># only the first field, which is the&nbsp;username.</p>
<p>echo&nbsp;&#8221;&#8220;</p>
<p>echo &#8220;Please select the user(s) whose home directories should also be
backed&nbsp;up:&#8221;</p>
<p>echo&nbsp;&#8221;&#8220;</p>
<p>for users in \$<span class="caps">USERLIST</span>;&nbsp;do</p>
<p>#need a way to assign numbers like \$1 \$2 \$3 to&nbsp;users</p>
<p>select users in \$<span class="caps">USERLIST</span>;&nbsp;do</p>
<p>case \$users&nbsp;in</p>
<p>#so that those numbers can be passed in over&nbsp;here</p>
<p>\$@)</p>
<p>echo &#8220;Please confirm that this is where you wish to store your full
backup:&nbsp;(&#8220;\$BACKUP_TO_LOCATION_\$i&#8221;)?&#8221;</p>
<p>select yn in &#8220;Yes&#8221; &#8220;No&#8221;;&nbsp;do</p>
<p>case \$yn&nbsp;in</p>
<p>Yes)</p>
<p>if [[ \$<span class="caps">KBPS</span> -gt \$<span class="caps">THRESHOLD</span> ]];&nbsp;then</p>
<p>duplicity full -vN &#8212;ssh-askpass &#8212;exclude /proc &#8212;exclude /mnt
&#8212;exclude /media &#8212;exclude /tmp &#8212;exclude /sys &#8212;exclude \$<span class="caps">HOME</span>/.local
&#8212;exclude \$<span class="caps">HOME</span>/.config exclude /var/log/&nbsp;\$BACKUP_TO_LOCATION_\$i</p>
<p>fi</p>
<p>break;;</p>
<p>No)</p>
<p>break;;</p>
<p>esac</p>
<p>done</p>
<p>break;;</p>
<p>esac</p>
<p>done</p>
<p>done</p>
<p>break;;</p>
<p>Incremental)</p>
<p>echo &#8220;Please confirm that this is where you wish to store your
incremental backup:&nbsp;(&#8220;\$BACKUP_TO_LOCATION_\$i&#8221;)?&#8221;</p>
<p>select yn in &#8220;Yes&#8221; &#8220;No&#8221;;&nbsp;do</p>
<p>case \$yn&nbsp;in</p>
<p>Yes)</p>
<p>if [[ \$<span class="caps">KBPS</span> -gt \$<span class="caps">THRESHOLD</span> ]];&nbsp;then</p>
<p>duplicity incremental -vN &#8212;ssh-askpass &#8212;exclude /proc &#8212;exclude /mnt
&#8212;exclude /media &#8212;exclude /tmp &#8212;exclude /sys &#8212;exclude \$<span class="caps">HOME</span>/.local
&#8212;exclude \$<span class="caps">HOME</span>/.config exclude /var/log /&nbsp;\$BACKUP_TO_OCATION_\$i</p>
<p>fi</p>
<p>break;;</p>
<p>No)</p>
<p>break;;</p>
<p>esac</p>
<p>done</p>
<p>esac</p>
<p>done</p>
<p>done</p>
<p>unset&nbsp;<span class="caps">PASSPHRASE</span></p>
<p>This can be added as a <a href="http://unixgeeks.org/security/newbie/unix/cron-1.html">crontab</a> (so that the script, in this crontab
example, will run automatically, once per hour at one minute after the
hour) by doing (but the script will still check the network connection
before sending anything&nbsp;out).</p>
<p>If you have any comments, suggestion, or feature requests, please [email
me][] and [my <span class="caps">GPG</span> public key is&nbsp;here][].</p>
<p>Features yet to be&nbsp;added:</p>
<p>Differentiation between Wifi, Ethernet, and 3G/4G&nbsp;connections.</p>
<p>Support for cleaning up old backups and how often to do&nbsp;so.</p>
<p>Configurable setting for what percentage of the available bandwidth
should be&nbsp;utilised.</p>
<p>~~Fix the bug in Duplicity that makes it default to <span class="caps">SFTP</span> when <span class="caps">SCP</span> is&nbsp;called.~~</p>
<p>[(or view it on github here)]: https://github.com/isis agora lovecruftlovecruft/duplikat
  [email me]: mailto:isis agora lovecruft@patternsinthevoid.net?Subject=Bash%20Backup%20Script
    &#8220;email me&#8221;
  [my <span class="caps">GPG</span> public key is here]: http://www.patternsinthevoid.net/isis agora lovecruft_pgp_public_key.html
    &#8220;my <span class="caps">GPG</span> public key is&nbsp;here&#8221;</p>
        </div><!-- /.entry-content -->
                
<hr><p>
<a href="./depression-has-infinite-recursion.html">
    <<< Depression Has Infinite&nbsp;Recursion</a>
<span class="readmore">
    <a href="./disassembly.html">
        Disassembly >>></a>
</span>
</p>
        </article>
</section>
<section id="extras" 
         class="body">
        <div class="blogroll">
        <h2>blogroll</h2>
        <ul>
                        <li><a href="https://fyb.patternsinthevoid.net">main</a></li>
                        <li><a href="https://blog.patternsinthevoid.net/isis.txt">keys</a></li>
                        <li><a href="https://code.patternsinthevoid.net">code</a></li>
                        <li><a href="https://blog.patternsinthevoid.net/calendar.html">time</a></li>
                        <li><a href="https://blog.patternsinthevoid.net/about.html">about</a></li>
                    </ul>
    </div>
    <!-- /.blogroll -->
            <div class="social">
        <h2>social</h2>
        <ul>
            <li><a href="https://blog.patternsinthevoid.net/feeds/all.atom.xml" 
                   type="application/atom+xml" 
                   rel="alternate">atom feed</a>
            </li>
                        
                        <li><a href="https://twitter.com/#!/isislovecruft">Twitter</a></li>
                        <li><a href="https://github.com/isislovecruft">Github</a></li>
                    </ul>
    </div><!-- /.social -->
    </section><!-- /#extras -->
<footer id="contentinfo" class="body" position="relative">
    <div style="height: 100%">
        <address id="about" class="vcard body">
            <a href="/about.html">Contact</a>
    </div>
        <style type="text/css">
div#info p {
    border:1px solid #000;
    background:#FFF; 
    margin-left:15px;
    margin-right:15px;
    position:absolute;
    z-index:500;
    bottom:0;
    padding:5px;
    font-size:4px;
    text-decoration:none; 
}
</style>
<div id="info">
    <p id="info" display="none">Thanks!
        <br>You're currently helping internet users</br>
        <br>in censored regions with FlashProxy!</br>
    </p>
</div>
<iframe src="//crypto.stanford.edu/flashproxy/embed.html" 
        width="80" height="15"
            frameborder="0" scrolling="no"
            accesskey="i"
            onmouseover="document.getElementById('info').style.display='block'"
            onmouseout="document.getElementById('info').style.display='none'"
            seamless>
    </iframe>
<!-- 
#info p {margin-left:15px; margin-right:20px;}
.tooltip {color:#FFF; display:none;}
.tooltip b {color:#FFF; display:none;}
.tooltip:hover {
    display=block;
    border:1px solid #000;
    background:#333;
    position:relative;
    z-index:500;
    left:25px;
    padding:5px;}
.tooltip:hover b {display:block; position:absolute; top:20px; padding:5px; font-weight:normal; color:#000; border:1px solid #888; background:#FFF; width:150px;}
.tooltip:hover b em {display:block; position:absolute; left:20px; top:-6px; width:11px; height:6px; background:#fff; display:block; font-size:1px;}
-->        </address><!-- /#about -->
</footer><!-- /#contentinfo -->
</body>
</html>